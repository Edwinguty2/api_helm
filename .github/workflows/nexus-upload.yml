name: Build and Upload Helm Chart to Nexus

on:
  push:
    branches:
      - main

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Helm
        uses: azure/setup-helm@v1
        with:
          version: 'v3.10.3'

      - name: Obtener última versión del backend
        id: get_version
        run: |
          # Consultar la API de Docker Hub y obtener los tags (excluyendo "latest")
          echo "Consultando Docker Hub para obtener tags..."
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/nicolasortiz05/back-taller/tags?page_size=100" | jq -r '.results[].name' | grep -v '^latest$')
          echo "Tags encontrados:"
          echo "$TAGS"
          
          # Ordenar los tags en orden semántico y tomar el último
          NUEVA_VERSION=$(echo "$TAGS" | sort -V | tail -n 1)
          echo "Nueva versión detectada: $NUEVA_VERSION"
          
          # Exportar la variable para los siguientes pasos
          echo "NUEVA_VERSION=$NUEVA_VERSION" >> $GITHUB_ENV

      - name: Actualizar tag en values.yaml
        run: |
          echo "Actualizando values.yaml con la versión: ${{ env.NUEVA_VERSION }}"
          sed -i "s/\(tag:\s*\).*/\1\"${{ env.NUEVA_VERSION }}\"/" myapihelm/values.yaml
          echo "Contenido actualizado de values.yaml:"
          cat myapihelm/values.yaml
          

      - name: Package Helm chart
        run: |
          helm package myapihelm
          ls -l *.tgz

      - name: Upload chart to Nexus
        env:
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          # Obtener el nombre del archivo .tgz generado (por ejemplo, myapihelm-0.1.0.tgz)
          CHART_FILE=$(ls -1 *.tgz)
          echo "Uploading $CHART_FILE to Nexus at ${NEXUS_URL}"
          # Usa curl para subir el archivo; la URL final debe incluir el nombre del archivo
          curl -v -u "${NEXUS_USERNAME}:${NEXUS_PASSWORD}" --upload-file "$CHART_FILE" "${NEXUS_URL}${CHART_FILE}"
